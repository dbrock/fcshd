#!/usr/bin/env ruby

begin
  require "fcshd"
rescue LoadError
  require "pathname"
  $: << File.expand_path("../../lib", Pathname.new(__FILE__).realpath)
  require "fcshd"
end

require "optparse"
require "socket"

def die(message)
  puts "#{File.basename($0)}: #{message}"
  exit 1
end

$source_directories = []
$library_filenames = []
$extra_arguments = []

OptionParser.new do |parser|
  parser.banner = "Usage: fcshc MAIN.[as|mxml] [SRC|LIB]... -o OUTPUT.swf"

  parser.on("-o", "--output FILENAME", "Write SWF to FILENAME") do |value|
    $output_filename = File.expand_path(value)
  end

  parser.on("-3", "Use -compatibility-version=3") do |value|
    $extra_arguments << "-compatibility-version=3"
  end

  parser.on("--no-flex", "Remove all runtime shared libraries (RSLs)") do
    $extra_arguments << "-runtime-shared-library-path="
  end

  parser.on("--halo", "Use the Halo theme") do
    die "must set $FLEX_HOME to use --halo option" if not FlexHome.known?
    $extra_arguments << "-theme=#{FlexHome.halo_swc}"
  end

  parser.on("--production", "Do not compile with debug information") do
    $production = true
  end

  parser.on("-X EXTRA-ARG", "Pass EXTRA-ARG to mxmlc (multiple allowed)") do |value|
    $extra_arguments << value
  end

  parser.on("-v", "--version", "Print `fcshc #{FCSHD::VERSION}' and exit") do
    puts "fcshc #{FCSHD::VERSION}"
    exit
  end

  parser.on("--verbose", "Print mxmlc command line") do
    $verbose = true
  end
end.parse!

$extra_arguments << "-debug" unless $production

for name in ARGV
  if not File.exists? name
    die "no such file or directory: #{name}"
  elsif File.directory? name
    $source_directories << File.expand_path(name)
  elsif %w(.as .mxml).include? File.extname(name)
    die "multiple source files not allowed" if $source_filename
    $source_filename = File.expand_path(name)
  elsif %w(.swc).include? File.extname(name)
    $library_filenames << File.expand_path(name)
  else
    die "don't know what to do with file: #{name}"
  end
end

if $source_filename == nil
  die "missing source file to compile"
end

if $source_directories == []
  $source_directories << File.dirname($source_filename)
end

if $output_filename == nil
  $source_filename.sub(/\.(as|mxml)$/, ".swf").tap do |filename|
    local_filename = File.basename(filename)
    $output_filename = File.expand_path(local_filename)
  end
end

$fcshd_arguments = ["mxmlc #$source_filename -output=#$output_filename"]

for directory in $source_directories
  $fcshd_arguments << "-compiler.source-path+=#{directory}"
  $fcshd_arguments << "-compiler.library-path+=#{directory}"
end

for filename in $library_filenames
  $fcshd_arguments << "-compiler.library-path+=#{filename}"
end

$fcshd_arguments.concat($extra_arguments)

begin
  host, port = "localhost", FCSHD::Server::PORT
  socket = TCPSocket.new(host, port)
rescue Errno::ECONNREFUSED
  die "could not connect to fcshd at #{host}:#{port}"
end

basedir = File.join(File.expand_path("."), "")

fcshd_command = $fcshd_arguments.join(" ")
warn fcshd_command.gsub(basedir, "") if $verbose
socket.puts fcshd_command

compiler_output = ""
socket.each_line do |line|
  case line
  when /^fcshd: /
    warn line.chomp
  else
    compiler_output << line
  end
end

transcript = FCSHD::Transcript[compiler_output]
puts transcript.to_s(basedir)
exit 1 if not transcript.succeeded?
